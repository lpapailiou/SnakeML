<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Snake ML Statistics</title>
  <link rel="shortcut icon" type="image/x-icon" href="www/images/favicon.png"/>
  <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <script src="https://cdn.amcharts.com/lib/4/core.js"></script>
  <script src="https://cdn.amcharts.com/lib/4/charts.js"></script>
  <script src="https://cdn.amcharts.com/lib/4/themes/animated.js"></script>
  <script src="https://cdn.amcharts.com/lib/4/themes/dark.js"></script>
  <script data-require="jquery@2.2.4" data-semver="2.2.4"
          src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
  <link data-require="bootstrap@3.3.7" data-semver="3.3.7" rel="stylesheet"
        href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"/>
  <script data-require="bootstrap@3.3.7" data-semver="3.3.7"
          src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script
      src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.1/js/bootstrap-select.min.js"></script>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.1/css/bootstrap-select.min.css"/>
  <link rel="stylesheet" href="www/css/style.css">
  <script src="www/js/GenStatistics.js"></script>
  <script src="www/js/RequestGenerator.js"></script>
</head>
<body>
<div class="four columns div-user-controls">
  <h2>SNAKE ML - STATISTICS</h2>
  <p>Visualising statistics of the Game "Snake ML"</p>
  <p>Pick one or more statistics from the dropdown below.</p>
  <button id="reload-button" onclick="loadCurrentBatchData()">Reload</button>
  <button id="loading-button" class="loading-button" disabled>Loading...</button>
  <div id="batch-selection-form">
  </div>
</div>


<div class="eight columns bg-grey">
  <div class="chart-template-div" id="chart__snake-length--batch-"></div>
  <div class="chart-template-div" id="chart__deaths--batch-"></div>
  <div class="chart-template-div" id="chart__fitness--batch-"></div>
  <div class="chart-template-div" id="chart__steps--batch-"></div>
</div>

<div id="empty-message" class="empty-message">Noch keine Speildaten einer AI vorhanden. Bitte starten Sie in der Applikation ein neuronales Netz.</div>

<script>

  const templateIds = [
    "chart__snake-length--batch-",
    "chart__deaths--batch-",
    "chart__fitness--batch-",
    "chart__steps--batch-",
  ];

  function loadCurrentBatchData() {
    console.log('oi');
    setLoadingState(true)

    loadJSON(response => {
      setLoadingState(false);
      const batches = JSON.parse(response);

      console.log(batches);


      handleEmptyMessage(batches)
      displayBatchSelectionForm(batches)
      displayCharts(batches);

    });
  }

  function displayBatchSelectionForm(batches) {
    let batchSelectionForm = document.getElementById('batch-selection-form');
    batchSelectionForm.textContent = null;

    batches.forEach((batch, batchNumber) => {
      let label = document.createElement('label');
      label.classList.add('batch-label');
      label.innerText = 'Batch #' + batchNumber;

      let radioButton = document.createElement('input');
      radioButton.type = 'radio';
      radioButton.id = 'batch-radio--id-' + batchNumber;
      radioButton.classList.add('batch-radio')

      label.appendChild(radioButton)
      batchSelectionForm.appendChild(label);
    });
  }

  function handleEmptyMessage(batches) {
    if(batches.length === 0) {
      document.getElementById('empty-message').classList.add('empty-message--visible');
    } else {
      document.getElementById('empty-message').classList.remove('empty-message--visible');
    }
  }

  function setLoadingState(isLoading) {
    let reloadButton = document.getElementById('reload-button')
    let loadingButton = document.getElementById('loading-button');
    if (isLoading) {
      reloadButton.disabled = true;
      reloadButton.classList.add('reload-button--loading');
      loadingButton.classList.add('loading-button--loading');
    }
    else
    {
      reloadButton.disabled = false;
      reloadButton.classList.remove('reload-button--loading')
      loadingButton.classList.remove('loading-button--loading');
    }
  }

  function displayCharts(batches) {
    batches.forEach((batch, batchNumber) => {
      batchNumber++;

      templateIds.forEach(templateId => {
        if (document.getElementById(templateId + batchNumber) === null) {
          cloneChartDiv(templateId, batchNumber);
        }
      });

      loadGraph(batch.generations, batchNumber)
    });
  }

  function cloneChartDiv(templateId, batchNumber) {
    const chartDivTemplate = document.getElementById(templateId);
    const chartDivClone = chartDivTemplate.cloneNode();
    chartDivClone.id = templateId + batchNumber;
    chartDivClone.classList.remove("chart-template-div")
    chartDivClone.setAttribute('data-batch-number', batchNumber);
    chartDivTemplate.after(chartDivClone);
  }

  window.onload = () => {
    loadCurrentBatchData();
  }
</script>

</body>
</html>