<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Snake ML Statistics</title>
  <link rel="shortcut icon" type="image/x-icon" href="./images/favicon.png"/>

  <!-- amCharts -->
  <script src="./lib/amcharts/core.js"></script>
  <script src="./lib/amcharts/charts.js"></script>
  <script src="./lib/amcharts/themes/animated.js"></script>
  <script src="./lib/amcharts/themes/dark.js"></script>

  <!-- bootstrap -->
  <link data-require="bootstrap@3.3.7" data-semver="3.3.7" rel="stylesheet"
        href="./lib/bootstrap/bootstrap.min.css"/>

  <!-- SnakeML -->
  <link rel="stylesheet" href="./css/style.css">

  <script src="./js/GenStatistics.js"></script>
  <script src="./js/SnakeMlClient.js"></script>

</head>
<body>
<div class="four columns div-user-controls">
  <h2>SNAKE ML - STATISTICS</h2>
  <p>Visualising statistics of the Game "Snake ML"</p>
  <p>Pick one or more statistics from the dropdown below.</p>
  <button id="reload-button" onclick="loadCurrentBatchData()">Reload</button>
  <button id="loading-button" class="loading-button" disabled>Loading...</button>
  <div id="batch-selection-form">
  </div>
</div>


<div id="charts-container" class="eight columns bg-grey">
  <div class="chart-template-div" id="chart__snake-length--batch-"></div>
  <div class="chart-template-div" id="chart__deaths--batch-"></div>
  <div class="chart-template-div" id="chart__fitness--batch-"></div>
  <div class="chart-template-div" id="chart__steps--batch-"></div>
</div>

<div id="empty-message" class="empty-message">Noch keine Spieldaten einer AI vorhanden. Bitte
  starten Sie ein neuronales Netz in der Applikation.
</div>

<script>

  const templateIds = [
    "chart__snake-length--batch-",
    "chart__deaths--batch-",
    "chart__fitness--batch-",
    "chart__steps--batch-",
  ];

  function loadCurrentBatchData() {
    setLoadingState(true)

    loadJSON(response => {
      setLoadingState(false);
      const batches = JSON.parse(response);

      handleEmptyMessage(batches)
      displayBatchSelectionForm(batches)
      displayCharts(batches);

    });
  }

  function displayBatchSelectionForm(batches) {
    let batchSelectionForm = document.getElementById('batch-selection-form');
    batchSelectionForm.textContent = null;

    batches.forEach((batch, batchNumber) => {
      let label = document.createElement('label');
      label.classList.add('batch-selection__label');
      label.innerText = 'Batch #' + (batchNumber + 1) + ' - ' + batch.configuration.algorithm;

      let checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.id = 'batch-selection__checkbox--id-' + batchNumber;
      checkbox.dataset.batchNumber = batchNumber;
      checkbox.classList.add('batch-selection__checkbox');
      checkbox.checked = true;
      checkbox.onclick = () => displayCharts(batches);

      label.appendChild(checkbox)
      batchSelectionForm.appendChild(label);
    });
  }

  function handleEmptyMessage(batches) {
    if (batches.length === 0) {
      document.getElementById('empty-message').classList.add('empty-message--visible');
    } else {
      document.getElementById('empty-message').classList.remove('empty-message--visible');
    }
  }

  function setLoadingState(isLoading) {
    let reloadButton = document.getElementById('reload-button')
    let loadingButton = document.getElementById('loading-button');
    if (isLoading) {
      reloadButton.disabled = true;
      reloadButton.classList.add('reload-button--loading');
      loadingButton.classList.add('loading-button--loading');
    } else {
      reloadButton.disabled = false;
      reloadButton.classList.remove('reload-button--loading')
      loadingButton.classList.remove('loading-button--loading');
    }
  }

  function displayCharts(batches) {
    const selectedBatchNumbers = getSelectedBatchNumbers();

    if (selectedBatchNumbers.length === 0) {
      document.getElementById('charts-container').style.display = 'none';
      return;
    }

    document.querySelectorAll('#charts-container > div:not(.chart-template-div)')
    .forEach(element => element.remove());

    document.getElementById('charts-container').style.display = 'block';


    console.log(batches);
    console.log(batches
    .filter((batch, index) => {
      console.log(selectedBatchNumbers.indexOf(index.toString()));
      return selectedBatchNumbers.indexOf(index) !== -1;
    }));



    batches
    .filter((batch, index) => selectedBatchNumbers.indexOf(index))
    .forEach((batch, batchNumber) => {
      batchNumber++;

      templateIds.forEach((templateId, index) => {
        if (document.getElementById(templateId + batchNumber) === null) {
          cloneChartDiv(templateId, batchNumber, batch);
        }
      });

      loadGraph(batch.generations, batchNumber);
    });
  }

  function getSelectedBatchNumbers() {
    return Array.from(document.getElementsByClassName('batch-selection__checkbox'))
    .filter(checkbox => checkbox.checked)
    .map(checkbox => checkbox.dataset.batchNumber);
  }

  function cloneChartDiv(templateId, batchNumber, batch) {
    const chartDivTemplate = document.getElementById(templateId);
    const chartDivClone = chartDivTemplate.cloneNode();
    chartDivClone.id = templateId + batchNumber;
    chartDivClone.classList.remove("chart-template-div")
    chartDivClone.setAttribute('data-batch-description', 'Batch #' + batchNumber + ' - ' + batch.configuration.algorithm);
    chartDivTemplate.after(chartDivClone);
  }

  window.onload = () => {
    loadCurrentBatchData();
  }

</script>

</body>
</html>